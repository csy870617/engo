<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ENGO - 영어회화 학습</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="style.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch((err) => console.log('SW registration failed.', err));
      });
    }
  </script>
</head>
<body>
  <div class="bg-glow"></div>

  <header>
    <div class="logo">ENGO</div>
    <div class="header-btns">
      <button class="icon-btn" onclick="openSyncModal()" style="font-size: 14px; width: auto; padding: 8px 12px; border-radius: 20px; background: rgba(255,255,255,0.1); color: #fff;">
        ☁ 학습내용 저장/불러오기
      </button>
      <button class="icon-btn" onclick="openSettingsModal()">⚙️</button>
    </div>
  </header>

  <main>
    <section id="page-home">
      <div class="hero-card">
        <h1>English & Go!</h1>
        <p>오늘도 영어 정복을 시작해볼까요?</p>
      </div>

      <div class="home-grid">
        <div class="home-tile tile-pattern" onclick="goTo('patterns')">
          <div class="tile-icon">📘</div>
          <div class="tile-content">
            <span class="label">패턴 학습</span>
            <span class="desc">핵심 표현 익히기</span>
          </div>
        </div>
        <div class="home-tile tile-word" onclick="goTo('words')">
          <div class="tile-icon">📙</div>
          <div class="tile-content">
            <span class="label">단어 학습</span>
            <span class="desc">필수 단어 암기</span>
          </div>
        </div>
        <div class="home-tile tile-idiom" onclick="goTo('idioms')">
          <div class="tile-icon">📗</div>
          <div class="tile-content">
            <span class="label">숙어 학습</span>
            <span class="desc">관용구 마스터</span>
          </div>
        </div>
        <div class="home-tile tile-conv" onclick="goTo('conversations')">
          <div class="tile-icon">💬</div>
          <div class="tile-content">
            <span class="label">대화 학습</span>
            <span class="desc">실전 회화 연습</span>
          </div>
        </div>
        <div class="home-tile tile-speaking" onclick="goTo('shadowing-list')">
          <div class="tile-icon">🗣️</div>
          <div class="tile-content">
            <span class="label">쉐도잉 훈련</span>
            <span class="desc">원어민 따라하기</span>
          </div>
        </div>
        <div class="home-tile tile-puzzle" onclick="goTo('puzzle')">
          <div class="tile-icon">🧩</div>
          <div class="tile-content">
            <span class="label">문장 퍼즐</span>
            <span class="desc">어순 감각 키우기</span>
          </div>
        </div>
      </div>
    </section>

    <section id="page-patterns" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('home')">❮ 뒤로</span><h2>패턴 학습</h2></div>
      <div class="card progress-card">
        <div class="progress-text" id="pattern-progress">0% 완료</div>
        <div class="progress-track"><div id="pattern-progress-bar" class="progress-fill"></div></div>
      </div>
      <div class="filter-area">
        <button id="pattern-studying-btn" class="chip-btn" onclick="togglePatternStudying()">암기 미완료만 보기</button>
        <input id="pattern-search" type="text" placeholder="검색..." class="search-input" oninput="renderPatternList()" />
      </div>
      <div id="pattern-list" class="list-view"></div>
    </section>

    <section id="page-pattern-detail" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('patterns')">❮ 목록</span></div>
      <div class="detail-card">
        <h1 id="pattern-title">Pattern</h1>
        <p id="pattern-desc">설명</p>
        <div class="check-row">
          <input type="checkbox" id="pattern-memorized-checkbox" onchange="togglePatternMemorizedDetail()" />
          <label for="pattern-memorized-checkbox">암기 완료 체크</label>
        </div>
      </div>
      <div class="content-area">
        <div class="control-bar">
          <button class="btn-small" onclick="playPatternExamples()">🔊 전체 듣기</button>
          <label class="toggle-label"><input type="checkbox" id="pattern-toggle-kr" checked onchange="renderPatternExamples()" /> 해석 보기</label>
        </div>
        <div id="pattern-examples" class="sentence-list"></div>
        <div class="nav-buttons">
          <button onclick="movePattern(-1)">이전</button>
          <button onclick="movePattern(1)">다음</button>
        </div>
      </div>
    </section>

    <section id="page-words" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('home')">❮ 뒤로</span><h2>단어장</h2></div>
      <div class="card progress-card">
        <div class="progress-text" id="word-progress">0%</div>
        <div class="progress-track"><div id="word-progress-bar" class="progress-fill"></div></div>
      </div>
      <div class="filter-area scroll-x">
        <button class="chip-btn active" data-word-level-btn="0" onclick="setWordLevel(0)">전체</button>
        <button class="chip-btn" data-word-level-btn="1" onclick="setWordLevel(1)">Lv.1</button>
        <button class="chip-btn" data-word-level-btn="2" onclick="setWordLevel(2)">Lv.2</button>
        <button class="chip-btn" data-word-level-btn="3" onclick="setWordLevel(3)">Lv.3</button>
        <button class="chip-btn" data-word-level-btn="4" onclick="setWordLevel(4)">Lv.4</button>
        <button class="chip-btn" data-word-level-btn="5" onclick="setWordLevel(5)">Lv.5</button>
        <button id="word-studying-btn" class="chip-btn outline" onclick="toggleWordStudying()">미암기만</button>
      </div>
      <input id="word-search" type="text" placeholder="단어 검색..." class="search-input mt-2" oninput="renderWordList()" />
      <div id="word-list" class="list-view"></div>
    </section>

    <section id="page-word-detail" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('words')">❮ 목록</span></div>
      <div class="detail-card">
        <h1 id="word-title">Word</h1>
        <p id="word-desc">뜻</p>
        <div class="check-row">
          <input type="checkbox" id="word-memorized-checkbox" onchange="toggleWordMemorizedDetail()" />
          <label for="word-memorized-checkbox">암기 완료</label>
        </div>
      </div>
      <div class="content-area">
        <div class="control-bar">
          <button class="btn-small" onclick="playWordExamples()">🔊 예문 듣기</button>
          <label class="toggle-label"><input type="checkbox" id="word-toggle-kr" checked onchange="renderWordExamples()" /> 해석</label>
        </div>
        <div id="word-examples" class="sentence-list"></div>
        <div class="nav-buttons">
          <button onclick="moveWord(-1)">이전</button>
          <button onclick="moveWord(1)">다음</button>
        </div>
      </div>
    </section>

    <section id="page-idioms" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('home')">❮ 뒤로</span><h2>숙어장</h2></div>
      <div class="card progress-card">
        <div class="progress-text" id="idiom-progress">0%</div>
        <div class="progress-track"><div id="idiom-progress-bar" class="progress-fill"></div></div>
      </div>
      <div class="filter-area scroll-x">
        <button class="chip-btn active" data-idiom-level-btn="0" onclick="setIdiomLevel(0)">전체</button>
        <button class="chip-btn" data-idiom-level-btn="1" onclick="setIdiomLevel(1)">Lv.1</button>
        <button class="chip-btn" data-idiom-level-btn="2" onclick="setIdiomLevel(2)">Lv.2</button>
        <button class="chip-btn" data-idiom-level-btn="3" onclick="setIdiomLevel(3)">Lv.3</button>
        <button class="chip-btn" data-idiom-level-btn="4" onclick="setIdiomLevel(4)">Lv.4</button>
        <button class="chip-btn" data-idiom-level-btn="5" onclick="setIdiomLevel(5)">Lv.5</button>
        <button id="idiom-studying-btn" class="chip-btn outline" onclick="toggleIdiomStudying()">미암기만</button>
      </div>
      <input id="idiom-search" type="text" placeholder="숙어 검색..." class="search-input mt-2" oninput="renderIdiomList()" />
      <div id="idiom-list" class="list-view"></div>
    </section>

    <section id="page-idiom-detail" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('idioms')">❮ 목록</span></div>
      <div class="detail-card">
        <h1 id="idiom-title">Idiom</h1>
        <p id="idiom-desc">뜻</p>
        <div class="check-row">
          <input type="checkbox" id="idiom-memorized-checkbox" onchange="toggleIdiomMemorizedDetail()" />
          <label for="idiom-memorized-checkbox">암기 완료</label>
        </div>
      </div>
      <div class="content-area">
        <div class="control-bar">
          <button class="btn-small" onclick="playIdiomExamples()">🔊 예문 듣기</button>
          <label class="toggle-label"><input type="checkbox" id="idiom-toggle-kr" checked onchange="renderIdiomExamples()" /> 해석</label>
        </div>
        <div id="idiom-examples" class="sentence-list"></div>
        <div class="nav-buttons">
          <button onclick="moveIdiom(-1)">이전</button>
          <button onclick="moveIdiom(1)">다음</button>
        </div>
      </div>
    </section>

    <section id="page-conversations" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('home')">❮ 뒤로</span><h2>실전 대화</h2></div>
      <input id="conv-search" type="text" placeholder="상황 검색 (예: 식당, 공항)..." class="search-input mb-4" oninput="renderConversationList()" />
      <div id="conv-list" class="list-view"></div>
    </section>

    <section id="page-conv-detail" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('conversations')">❮ 목록</span></div>
      <div class="detail-card">
        <h1 id="conv-title">Conversation</h1>
        <div class="action-row">
          <button class="btn-main" onclick="playConversationAll()">🔊 전체 듣기</button>
          <button class="btn-sub" onclick="startShadowingFromConv(currentConvId)">🗣️ 바로 쉐도잉</button>
        </div>
      </div>
      <div class="content-area">
        <div class="control-bar right">
          <label class="toggle-label"><input type="checkbox" id="conv-toggle-kr" checked onchange="renderConversationDetail()" /> 해석 보기</label>
        </div>
        <div id="conv-lines" class="chat-list"></div>
        <div class="nav-buttons">
          <button onclick="moveConv(-1)">이전 대화</button>
          <button onclick="moveConv(1)">다음 대화</button>
        </div>
      </div>
    </section>

    <section id="page-shadowing-list" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('home')">❮ 뒤로</span><h2>쉐도잉 목록</h2></div>
      <p class="subtext" style="margin-bottom: 15px; color:var(--text-sub);">연습하고 싶은 대화 주제를 선택하세요.</p>
      <input id="shadowing-search" type="text" placeholder="주제 검색..." class="search-input mb-4" oninput="renderShadowingList()" />
      <div id="shadowing-list-container" class="list-view"></div>
    </section>

<section id="page-shadowing" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('shadowing-list')">❮ 목록</span></div>
      
      <div class="game-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h2 style="margin:0;">🗣️ 쉐도잉</h2>
          <span id="shadowing-counter" style="font-size:0.9rem; color:var(--text-sub);">1 / 10</span>
        </div>

        <div class="shadowing-controls-row">
          <button id="btn-blind-mode" class="toggle-btn" onclick="toggleShadowingOption('blind')">🙈 블라인드 모드</button>
          <button id="btn-hide-kr" class="toggle-btn" onclick="toggleShadowingOption('hideKr')">🇰🇷 해석 숨김</button>
        </div>
        
        <div class="shadowing-display" onclick="revealTextTemp()" style="min-height: 140px; display:flex; flex-direction:column; justify-content:center; margin-bottom:20px; cursor:pointer;">
          <p id="shadowing-speaker" style="color:var(--accent); font-weight:bold; font-size:0.9rem; margin-bottom:12px;">Speaker A</p>
          
          <p id="shadowing-text" class="blind-text" style="font-size:1.4rem; font-weight:700; line-height:1.4; color:#fff; margin-bottom:12px;">
            Ready...
          </p>
          
          <p id="shadowing-kr" style="color:var(--text-sub); font-size:1rem;">준비...</p>
          
          <p id="shadowing-hint" style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:15px;">(문장을 터치하면 잠시 보입니다)</p>
        </div>

        <div style="text-align: center; margin-bottom: 25px;">
            <button id="shadowing-play-btn" onclick="playShadowingCurrent()" aria-label="다시 듣기" style="width: 80px; height: 80px; border-radius: 50%; padding:0; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: 4px solid #fff; box-shadow: 0 10px 20px rgba(124, 58, 237, 0.3); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition: transform 0.1s;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M15.54 8.46C16.4774 9.39764 17.004 10.6692 17.004 11.995C17.004 13.3208 16.4774 14.5924 15.54 15.53" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M19.07 4.93C20.9447 6.80527 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <p class="subtext" style="margin-top: 10px; font-size:0.9rem;">다시 듣기 (반복)</p>
        </div>

        <div class="game-controls" style="display:flex; gap:10px;">
          <button class="btn-sub" onclick="prevShadowing()" style="flex:1;">❮ 이전</button>
          <button class="btn-main" onclick="nextShadowing()" style="flex:2;">다음 문장 ❯</button>
        </div>
      </div>
    </section>

<section id="page-puzzle" class="hidden">
      <div class="nav-header"><span class="back-btn" onclick="goTo('home')">❮ 나가기</span></div>
      
      <div class="game-card">
        <div class="game-header" style="justify-content:center; position:relative;">
          <h2>🧩 문장 퍼즐</h2>
          </div>
        
        <div style="text-align:center; margin-bottom:15px; color:var(--text-sub); font-size:0.9rem;">
          <span id="puzzle-counter">1 / 100</span>
        </div>

        <p class="puzzle-kr" id="puzzle-question" style="min-height:3rem;">문제가 나옵니다...</p>
        
        <div id="puzzle-target" class="puzzle-slot"></div>
        <div id="puzzle-bank" class="puzzle-pieces"></div>
        
        <div id="puzzle-feedback" class="feedback-msg"></div>
        
        <div class="game-bottom" style="margin-top:20px; display:flex; gap:10px;">
          <button class="btn-sub" onclick="resetPuzzle()" style="flex:1;">↺ 다시</button>
          <button class="btn-main" onclick="checkPuzzle()" style="flex:2;">정답 확인</button>
        </div>
      </div>

      <div class="nav-buttons">
        <button onclick="movePuzzle(-1)">이전 문제</button>
        <button onclick="movePuzzle(1)">다음 문제</button>
      </div>
    </section>

  </main>

  <div id="settings-modal" class="modal hidden">
    <div class="modal-box">
      <h3>설정</h3>
      <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <label for="tts-autoplay-toggle" style="color:#fff; cursor:pointer;">상세화면 자동 재생</label>
        <input type="checkbox" id="tts-autoplay-toggle" style="width:20px; height:20px; accent-color:var(--primary); cursor:pointer;">
      </div>
      <div class="setting-item">
        <label>목소리 선택</label>
        <select id="tts-voice-select" class="dropdown" onchange="previewVoiceSettings()"><option>기본</option></select>
      </div>
      <div class="setting-item">
        <label>속도 <span id="tts-rate-label">1.0</span></label>
        <input type="range" id="tts-rate-range" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateRateLabel()" onchange="previewVoiceSettings()">
      </div>
      <div class="modal-btns">
        <button class="btn-sub" onclick="closeSettingsModal()">취소</button>
        <button class="btn-main" onclick="saveSettings()">저장</button>
      </div>
    </div>
  </div>

  <div id="sync-modal" class="modal hidden">
    <div class="modal-box">
      <h3>학습내용 저장/불러오기</h3>
      <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:16px;">
        아이디와 비밀번호를 직접 정해서 데이터를 백업하거나 불러오세요.
      </p>
      <input type="text" id="sync-id" class="input-field" placeholder="아이디 (예: myname123)" />
      <input type="password" id="sync-pw" class="input-field" placeholder="비밀번호 (잊지 않게 주의!)" />
      <div class="modal-btns vertical">
        <button class="btn-main" onclick="uploadData()">☁ 서버에 저장하기</button>
        <button class="btn-sub" onclick="downloadData()">📥 서버에서 불러오기</button>
        <button class="btn-text" onclick="closeSyncModal()">닫기</button>
      </div>
    </div>
  </div>

  <script src="pattern.js"></script>
  <script src="conversation.js"></script>
  <script src="idiom.js"></script>
  <script src="word.js"></script>
  <script src="script.js"></script>
</body>
</html>
